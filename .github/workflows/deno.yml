name: Validate changes

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  ZEPHYR_TOKEN: ${{ secrets.ZEPHYR_TOKEN }}
  JIRA_PAT: ${{ secrets.JIRA_PAT }}
  EMAIL: ${{ secrets.EMAIL }}

jobs:
  test:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Setup repo
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - uses: denoland/setup-deno@4606d5cc6fb3f673efd4f594850e3f4b3e9d29cd # v2.0.0
        with:
          deno-version: "2.1.5"

      - name: Verify formatting
        run: deno task check

      - name: Validate changes
        run: deno task validate

      - name: Validate all
        run: deno task validate-all

      - name: Check spellings
        uses: codespell-project/actions-codespell@406322ec52dd7b488e48c1c4b82e2a8b3a1bf630 # v2.1
        with:
          ignore_words_file: .codespellignore
          path: data

  post-merge-sync:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Setup repo
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - uses: denoland/setup-deno@4606d5cc6fb3f673efd4f594850e3f4b3e9d29cd # v2.0.0
        with:
          deno-version: "2.1.5"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run save and sync
        run: |
          deno task save
          deno task sync

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "No changes"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        run: |
          BRANCH_NAME=ci/update-after-merge-$(date +%s)
          git checkout -b $BRANCH_NAME
          git add .
          git commit -m "Chore: Data Sync after merge to main"
          git push origin $BRANCH_NAME

          gh pr create \
            --title "Chore: Data Sync after merge to main" \
            --body "Auto-generated PR to commit results of \`deno task save\` and \`deno task sync\`" \
            --head "$BRANCH_NAME" \
            --base main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
